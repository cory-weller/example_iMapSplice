# running iMapSplice

After cloning this repository to your own directory... (on Rivanna, /scratch/$USER/ is a good location)

## Prepare reference genome files in `/reference_genome/`
The reference genome needs to be split into separate `.fa` files instead of multiple sequences contained in a single file. The name of the file must be identical to the contents of the header line (excluding the `>` character at the start of the header). For example, `chr3.fa` would look like

```bash
>chr3
ATCGATCGACTGACTACTAGC
TAATCGATCGACTGACTACTA
GCTAATCGATCGACTGACTAC
TAGCTAATCGATCGACTGACT
```

If you have a single reference genome file with multiple sequences, you'll need to split it up. This conversion can be done using the script `splitFastaFiles.sh` within the `scripts` directory. Remove the original multi-sequence file afterwards.

## Prepare a gene annotation file in `/geneAnnotationFile/`
The gene annotation file needs to be in a specific format:

| column |           value          |
| ------ | ------------------------ |
|   1    | id                       |
|   2    | chromosome               |
|   3    | strand                   |
|   4    | transcription start pos  |
|   5    | transcription end pos    |
|   6    | coding region start pos  |
|   7    | coding region end pos    |
|   8    | exon count               |
|   9    | exon start positions     |
|   10   | exon end positions       |
|   11   | additional information 1 |
|   12   | additional information 2 |

The above format can be generated from the *GenePred* format output by the UCSC genome browser. See `convertToGAF.sh` within the `scripts` directory. Read more about the *GenePred* format [here](https://genome.ucsc.edu/FAQ/FAQformat.html#format9)

The gene annotation file should only contain the chromosomes (or scaffolds) that have a `.fasta` file--meaning the names should match one-to-one. You can prune the gene annotation file using `prune_GAF.sh` in the `scripts` directory.

## Prepare a SNP list in `/SNPS/`
The SNP file should be a **tab-delimited** file with no header and four columns:

| column |                value               |
| ------ | ---------------------------------- |
|   1    | chromosome/scaffold (character)    |
|   2    | BP position (integer)              |
|   3    | Reference SNP (single nucleotide)  |
|   4    | Alternate SNP (single nucleotide)  |

The SNP file can be generated by extracting only SNPs (no indels or multi-allelic sites) from a VCF file. As before, the values in the first colulmn (chromosome/scaffold) should match the chromosome names in the gene annotation file, and the names of the `.fasta` reference genome files.

## Prepare a file of all sample file stems/IDs
This will be a list that contains a unique identifier for every sequenced sample. For example, if one sequencing read produces `sample01_R1_001.fastq.gz` and `sample01_R2_002.fastq.gz`, the unique ID for that file could be simply `sample01`. A file of file stems can be made with something akin to:

```bash
ls /path/to/sequencing_reads/*.fastq.gz | cut -d "_" -f 1 | sort -u > filestems.txt
```


## Edit the `slurm.config` file
This file contains variables that will be used when generating required index files and mapping the sequencing reads. Edit any variables that are specific to your intended tasks.

## Build the required index files
While in the main project directory, run `bash ./iMapSplice_map_reads.slurm` to extract variables from the `slurm.config` file that you edited and submit the job to index files. It should take a couple hours, minimum. If you add your email and keep `mail_notifications` to `ALL` then you should receive an email when the job completes.

## Map sequencing reads

Test if everything is configured appropriately by running `iMapSplice_map_reads.slurm` as-is, which submits a job array of size 1. It will only try to map the first sample's reads, i.e. the first line within your file of file stems.

```bash
bash ./iMapSplice_map_reads.slurm
```

If it works appropriately, you can edit the `sbatch` command inside the `iMapSplice_map_reads.slurm`, so that the array spans the number of samples to map. E.g., with 250 samples, you would edit the option to be `--array=1-250%10` to run a total of 250 mapping jobs, with at most 10 running simultaneously.
